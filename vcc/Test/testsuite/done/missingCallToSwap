#include <vcc2.h>
#include <sal.h>

typedef unsigned __int8 UINT8;
typedef unsigned __int64 UINT64, *PUINT64;

static void swap(UINT8 arr[], UINT64 lo, UINT64 hi, UINT64 count)
  requires(0 <= lo && lo <= hi && hi < count)
  ensures(arr[lo] == old(arr[hi]))
  ensures(arr[hi] == old(arr[lo]))
  ensures(forall(UINT64 i; 0 <= i && i < count && i != lo && i != hi ==> arr[i] == old(arr[i])))
  ensures(is_mutable_array(arr, count))
  requires(is_thread_local_array(arr, count))
  writes(array_range(arr, count))
{
  UINT8 tmp;
  tmp = arr[hi];
  arr[hi] = arr[lo];
  arr[lo] = tmp;
}

static void foo(UINT8 arr[], UINT64 count)
  requires(count > 0 && count < (1UI64 << 40)) 
  requires(is_thread_local_array(arr, count))
  writes(array_range(arr, count))
{
  UINT64 p, max, hi;
  hi = count-1;

  assert(forall(UINT64 i,j; 0 <= i && i < j && j < count && hi < j ==> arr[i] <= arr[j]));
  assume(arr[0] >= arr[hi]);
  swap(arr, 0, hi, count);
  assert(arr[0] <= arr[hi]);
}

`
Verification of swap succeeded.
Verification of foo succeeded.
`
