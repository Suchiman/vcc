#include "vcc.h"

struct A {
  int a;
  int b;
  int c;
};

struct IntWrap {
  int i;
};

struct PtrWrap {
  int* p;
};

union B {
  struct A x;
  struct IntWrap y;
  struct PtrWrap z;
};

void reint(union B *b)
  writes(extent(b))
{
  assert(set_in(&b->y.i, extent(b)));
  b->y.i = 7;
}
`
Verification of reint failed.
testcase(26,12) : error VC9500: Assertion '_vcc_set_in(&b->y.i,_vcc_extent(b))' did not verify.
`
#include "vcc.h"

struct A {
  int a;
  int b;
  int c;
};

struct IntWrap {
  int i;
};

struct PtrWrap {
  int* p;
};

union B {
  struct A x;
  struct IntWrap y;
  struct PtrWrap z;
};

void reint(union B *b)
  requires(typed(b))
  writes(extent(b))
{
  union_reinterpret(b, y);
  b->y.i = 7;
  assert(b->y.i == 7);
  union_reinterpret(b, z);
  union_reinterpret(b, x);
  assert(b->x.a == 7);
}
`
Verification of reint failed.
testcase(32,12) : error VC9500: Assertion 'b->x.a == 7' did not verify.
`
#include <vcc2test.h>


union A {
  int tag;
  struct {
    int tag;
    int b;
  } a;
  struct {
    int tag;
    short b;
  } b;
};

struct Common {
  int tag;
  int size;
};

union A2 {
  int tag;
  struct {
    struct Common c;
    int b;
  } a;
  struct {
    struct Common c;
    short b;
  } b;
};

union A3 {
  struct {
    int a;
    int b;
  } s;
  int arr[10];
};

void fooShouldFail(union A *a, union A2 *a2)
  requires(thread_local(a) && thread_local(&a->a))
  requires(thread_local(a2) && thread_local(&a2->a.c))
  writes(&a->tag, &a2->tag)
{
  a->tag = 10;
  a2->tag = 42; // the embedding of the two tag fields is unknown so we cannot frame the writes
  assert(a2->tag == 42);
  assert(a->tag == 10);
}

void foo1(union A *a, union A2 *a2)
  requires(thread_local(a) && thread_local(&a->a))
  requires(thread_local(a2) && thread_local(&a2->a.c))
  writes(&a->tag, &a2->tag)
{
  a->tag = 10;
  assert(a->tag == 10);
}

void foo2(union A *a, union A2 *a2)
  requires(thread_local(a) && thread_local(&a->a))
  requires(thread_local(a2) && thread_local(&a2->a.c))
  writes(&a->tag, &a2->tag)
{
  a2->tag = 42;
  assert(a2->tag == 42);
}

void bar(union A3 *a)
  requires(typed(a) && typed(&a->arr[3]))
{
  int x = a->arr[3];
}
`
Verification of fooShouldFail failed.
testcase(49,12) : error VC9500: Assertion 'a->tag == 10' did not verify.
Verification of foo1 succeeded.
Verification of foo2 succeeded.
Verification of bar failed.
testcase(73,11) : error VC8512: Assertion 'a->arr[3] is thread local' did not verify.
`
