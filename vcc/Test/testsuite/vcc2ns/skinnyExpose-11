#include <vcc.h>

struct A {
  int x;
  int y;
};

struct B {
  struct A a;
  invariant(keeps(&a))
};

struct C {
  struct B b;
  int z;
  int z2;
  invariant(keeps(&b))
};

void up1(int sw, struct B *b)
  writes(b)
  maintains(wrapped(b))
  ensures(sw ==> domain_updated_at(b, SET(&b->a.x)))
  ensures(!sw ==> domain_updated_at(b, SET(&b->a.y)))
{
  if (sw) {
    skinny_expose(b, &b->a)
      writes(&b->a.x)
    {
      b->a.x = 1;
    }
  } else {
    skinny_expose(b, &b->a)
      writes(&b->a.x)
    {
      b->a.x = 1;
    }
  }
}

void up1b(int sw, struct B *b)
  writes(b)
  maintains(wrapped(b))
  //ensures(sw ==> domain_updated_at(b, SET(&b->a.x)))
  ensures(!sw ==> domain_updated_at(b, SET(&b->a.y)));

void up2(struct C *c)
  writes(c)
  requires(wrapped(c))
{
  skinny_expose(c)
    writes(&c->b.a.x)
  {
    up1(1, &c->b);
  }
}

void up2b(struct C *c)
  writes(c)
  requires(wrapped(c))
{
  skinny_expose(c)
    writes(&c->b.a.y, &c->b)
  {
    up1(1, &c->b);
  }
}

void up2c(struct C *c)
  writes(c)
  requires(wrapped(c))
{
  skinny_expose(c)
    writes(&c->b)
  {
    up1(1, &c->b);
  }
}

void up2d(struct C *c)
  writes(c)
  requires(wrapped(c))
  ensures(domain_updated_at(c, SET(&c->b.a.y)))
{
  skinny_expose(c)
    writes(&c->b.a.x, &c->b)
  {
    up1(1, &c->b);
  }
}

void up2f(struct C *c)
  writes(c)
  requires(wrapped(c))
  ensures(domain_updated_at(c, SET(&c->b.a.x)))
{
  skinny_expose(c)
    writes(&c->b.a.x, &c->b)
  {
    up1b(1, &c->b);
  }
}

void up2ok(struct C *c)
  writes(c)
  requires(wrapped(c))
  ensures(domain_updated_at(c, SET(&c->b.a.x)))
{
  skinny_expose(c)
    writes(&c->b.a.x, &c->b)
  {
    up1(1, &c->b);
  }
}

void up3(struct C *c)
  writes(c)
  requires(wrapped(c))
  ensures(domain_updated_at(c, SET(&c->b.a.x, &c->z)))
{
  skinny_expose(c)
    writes(&c->b.a.x, &c->z, &c->b)
  {
    up1(1, &c->b);
    c->z2 = 12;
  }
}

void up4(struct C *c)
  writes(c)
  requires(wrapped(c))
  ensures(domain_updated_at(c, SET(&c->b.a.x, &c->z)))
{
  skinny_expose(c)
    writes(&c->b.a.x, &c->z, &c->b)
  {
    c->z2 = 12;
    up1(1, &c->b);
  }
}

void up5(struct C *c)
  writes(c)
  requires(wrapped(c))
  ensures(domain_updated_at(c, SET(&c->b.a.x, &c->z)))
{
  skinny_expose(c)
    writes(&c->b.a.x, &c->z, &c->b)
  {
    c->z2 = 12;
    up1(1, &c->b);
    c->z = 13;
  }
}

void up6(struct C *c)
  writes(c)
  requires(wrapped(c))
  ensures(domain_updated_at(c, SET(&c->b.a.x, &c->z)))
{
  skinny_expose(c)
    writes(&c->b.a.x, &c->z, &c->b)
  {
    c->z = 12;
    up1(1, &c->b);
    c->z2 = 13;
  }
}
`
Verification of B#adm succeeded.
Verification of C#adm succeeded.
Verification of up1 failed.
testcase(39,1) : error VC9501: Post condition '!sw ==> _vcc_domain_updated_at(b, _vcc_create_set(_vcc_dummy_set_element(), &b->a.y))' did not verify.
testcase(24,13) : error VC9599: (related information) Location of post condition.
Verification of up2 failed.
testcase(51,28) : error VC8530: Assertion 'skinny_expose(c, ...) body has written at an unlisted location' did not verify.
Verification of up2b failed.
testcase(62,28) : error VC8530: Assertion 'skinny_expose(c, ...) body has written at an unlisted location in a domain' did not verify.
Verification of up2c failed.
testcase(73,28) : error VC8530: Assertion 'skinny_expose(c, ...) body has written at an unlisted location in a domain' did not verify.
Verification of up2d failed.
testcase(90,1) : error VC9501: Post condition '_vcc_domain_updated_at(c, _vcc_create_set(_vcc_dummy_set_element(), &c->b.a.y))' did not verify.
testcase(83,13) : error VC9599: (related information) Location of post condition.
Verification of up2f failed.
testcase(97,28) : error VC8530: Assertion 'skinny_expose(c, ...) body has written at an unlisted location in a domain' did not verify.
Verification of up2ok succeeded.
Verification of up3 failed.
testcase(121,28) : error VC8530: Assertion 'skinny_expose(c, ...) body has written at an unlisted location' did not verify.
Verification of up4 failed.
testcase(134,28) : error VC8530: Assertion 'skinny_expose(c, ...) body has written at an unlisted location' did not verify.
Verification of up5 failed.
testcase(147,28) : error VC8530: Assertion 'skinny_expose(c, ...) body has written at an unlisted location' did not verify.
Verification of up6 failed.
testcase(161,28) : error VC8530: Assertion 'skinny_expose(c, ...) body has written at an unlisted location' did not verify.
`
