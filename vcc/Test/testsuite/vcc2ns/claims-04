#include <vcc.h>

struct vcc(claimable) A {
  volatile int x;
  invariant( old(this->x) == this->x || old(this->x) + 1 == this->x )
};

void foo(struct A *a claimp(c))
  writes(c)
  requires(wrapped(c) && claims(c, closed(a)))
{
  unclaim(c);
}

void foo2(struct A *a claimp(c))
  requires(wrapped(c) && claims(c, closed(a)))
  requires(ref_cnt(c) == 0)
{
  unclaim(c);
}

void foo4(struct A *a claimp(c))
  writes(c, a)
  requires(wrapped(c) && claims(c, closed(a)))
  requires(ref_cnt(c) == 0)
{
  unclaim(c, a);
}

void foo6(struct A *a claimp(c))
  writes(c)
  requires(wrapped(c) && claims(c, closed(a)))
  requires(ref_cnt(c) == 0 && claims_obj(c, a))
{
  unclaim(c, a);
}

void foo7(struct A *a claimp(c))
  writes(c, a)
  requires(wrapped(c) && claims(c, closed(a)))
  requires(ref_cnt(c) == 0 && claims_obj(c, a))
{
  unclaim(c, a, a);
}

void ok1(struct A *a claimp(c))
  writes(c)
  requires(wrapped(c) && claims(c, closed(a)))
  requires(ref_cnt(c) == 0)
{
  unclaim(c);
}


void ok2(struct A *a claimp(c))
  writes(c, a)
  requires(wrapped(c) && claims(c, closed(a)))
  requires(ref_cnt(c) == 0 && claims_obj(c, a))
{
  unclaim(c, a);
}

void ok3(struct A *a, struct A *b claimp(c))
  writes(c, a, b)
  requires(wrapped(c) && claims(c, closed(a)))
  requires(ref_cnt(c) == 0 && claims_obj(c, a) && claims_obj(c, b) && a != b)
{
  unclaim(c, a, b);
}

void foo8(struct A *a, struct A *b claimp(c))
  writes(c, a, b)
  requires(wrapped(c) && claims(c, closed(a)))
  requires(ref_cnt(c) == 0 && claims_obj(c, a) && claims_obj(c, b))
{
  unclaim(c, a, b);
}

`
Verification of A#adm succeeded.
Verification of foo failed.
testcase(12,3) : error VC9502: Call '_vcc_unclaim(c)' did not verify.
testcase(0,0) : error VC9599: (related information) Precondition: 'the claim has no outstanding references'.
Verification of foo2 failed.
testcase(19,3) : error VC8523: Assertion 'the disposed claim c is writable' did not verify.
Verification of foo4 failed.
testcase(27,3) : error VC8522: Assertion 'object a was claimed by c' did not verify.
Verification of foo6 failed.
testcase(35,3) : error VC8008: a is non-writable and its owner is not listed in atomic(...) (and thus is impossible to unclaim).
Verification of foo7 failed.
testcase(43,3) : error VC8010: object a might equal a.
Verification of ok1 succeeded.
Verification of ok2 succeeded.
Verification of ok3 succeeded.
Verification of foo8 failed.
testcase(76,3) : error VC8010: object a might equal b.
`
