#include <vcc.h>

struct X {
  int x;
  invariant(x > 7)
};

struct X *get_x()
  ensures(closed(result));

struct X *test_ens()
  ensures(inv(result))
  ensures(result->x > 4)
{
  return get_x();
}

struct X *test_ens_may_fail()
  ensures(result->x > 4)
  ensures(inv(result))
{
  return get_x();
}

void test_req(struct X *p)
  requires(inv(p))
  requires(p->x > 3)
{
}

void use_test_req(struct X *p)
  requires(closed(p))
{
  test_req(p);
}

void test_req_inv(struct X *p)
  requires(p->x > 3)
  requires(inv(p))
{
}

void use_test_req_may_fail(struct X *p)
  requires(closed(p))
{
  test_req_inv(p);
}

void loop_inv()
{
  struct X *p = get_x();
  int k;

  while(1)
    invariant(inv(p))
    invariant(p->x > 3)
  {
    k = 7;
  }
}

void loop_inv_may_fail()
{
  struct X *p = get_x();
  int k;

  while(1)
    invariant(p->x > 3)
    invariant(inv(p))
  {
    k = 7;
  }
}

spec(
ispure bool f1(int x)
  reads(set_universe())
  returns(x > 0); )
spec(
ispure bool f2(int x)
  reads(set_universe()) ; )

axiom(forall(int x; {f1(x)} f1(x) ==> f2(x)));

struct A {
  int x;
  invariant(f1(x))
  invariant(f2(x))
};

void wrap_order(struct A *a)
  writes(extent(a))
{
  a->x = 7;
  wrap(a);
}

struct A_may_fail {
  int x;
  invariant(f2(x))
  invariant(f1(x))
};

void wrap_order_may_fail(struct A_may_fail *a)
  writes(extent(a))
{
  a->x = 7;
  wrap(a);
}

`
Verification of X#adm succeeded.
Verification of A#adm succeeded.
Verification of A_may_fail#adm failed.
testcase(100,15) : error VC8012: invariant(f2(x)) of A_may_fail is not admissible.
testcase(100,15) : error VC8018: invariant(f2(x)) of A_may_fail forbids unwrapping.
Verification of test_ens succeeded.
Verification of test_ens_may_fail failed.
testcase(22,3) : error VC9501: Post condition 'result->x > 4' did not verify.
testcase(19,13) : error VC9599: (related information) Location of post condition.
Verification of test_req succeeded.
Verification of use_test_req succeeded.
Verification of test_req_inv succeeded.
Verification of use_test_req_may_fail failed.
testcase(46,3) : error VC9502: Call 'test_req_inv(p)' did not verify.
testcase(38,14) : error VC9599: (related information) Precondition: 'p->x > 3'.
Verification of loop_inv succeeded.
Verification of loop_inv_may_fail failed.
testcase(68,17) : error VC9500: Loop entry invariant 'p->x > 3' did not verify.
Verification of wrap_order succeeded.
Verification of wrap_order_may_fail failed.
testcase(108,13) : error VC8014: invariant(f2(x)) of A_may_fail fails on wrap.
testcase(100,15) : error VC9599: (related information) location of the invariant.
`
