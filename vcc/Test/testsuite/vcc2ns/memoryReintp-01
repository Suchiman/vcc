#include <vcc2test.h>

typedef unsigned char byte;

void *alloc(unsigned __int64  sz)
  ensures(is_object_root(as_array((byte*)result, sz)))
  ensures(mutable(as_array((byte*)result, sz)))
  ensures(is_fresh(as_array((byte*)result, sz)))
  ;

struct A {
  int x , y;
};

void f1()
{
  struct A * a = alloc(sizeof(struct A));
  from_bytes(a, false);
  a->x = 10;
  a->y = 20;
}

void flatten(struct A *a)
  writes(extent(a))
  requires(is_object_root(a))
{
  byte*p = (byte*) a;

  to_bytes(a);
  p[2] = 10;
}

void shouldFail(byte *p)
  // missing writes
  requires(mutable(as_array(p, sizeof(struct A))) && 
           is_object_root(as_array(p, sizeof(struct A))))
{
  from_bytes((struct A*)p, false);
  ((struct A*)p)->x = 10;
}


void flattenFail1(struct A *a)
  writes(extent(a))
  requires(is_object_root(a))
{
  byte*p = (byte*) a;

  to_bytes(a);
  p[9] = 10;
}

void flattenFail2(struct A *a)
  writes(extent(a))
{
  to_bytes(a);
}

void flattenFail3(struct A *a)
  requires(mutable(a) && is_object_root(a))
{
  to_bytes(a);
}

void joinShouldFail2(int *p)
  writes(extent(as_array(p, sizeof(struct A))))
  requires(mutable(as_array((byte*)p, sizeof(struct A))) && 
           is_object_root(as_array((byte*)p, sizeof(struct A))))
{
  from_bytes((struct A*)p, false);
}

`
Verification of f1 succeeded.
Verification of flatten succeeded.
Verification of shouldFail failed.
testcase(38,3) : error VC8510: Assertion 'as_array((uint8_t*)(struct A*)p, 8) is writable in call to _vcc_from_bytes((struct A*)p, ((bool)0))' did not verify.
Verification of flattenFail1 failed.
testcase(50,3) : error VC8507: Assertion 'p[9] is writable' did not verify.
Verification of flattenFail2 failed.
testcase(56,3) : error VC9502: Call '_vcc_to_bytes(a)' did not verify.
testcase(0,0) : error VC9599: (related information) Precondition: 'the reinterpreted object is not embedded inside of another object'.
Verification of flattenFail3 failed.
testcase(62,3) : error VC8510: Assertion 'a is writable in call to _vcc_to_bytes(a)' did not verify.
Verification of joinShouldFail2 failed.
testcase(70,3) : error VC8510: Assertion 'as_array((uint8_t*)(struct A*)p, 8) is writable in call to _vcc_from_bytes((struct A*)p, ((bool)0))' did not verify.
`
